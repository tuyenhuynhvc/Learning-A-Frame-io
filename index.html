<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>A-Frame Farm Scene</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="./components/barn.js"></script>
    <script src="./components/fence.js"></script>
    <script src="./components/animal.js"></script>
    <script src="./components/cow.js"></script>
    <script src="./components/rice.js"></script>
    <script src="./components/mill.js"></script>
    <script src="./components/chicken.js"></script>
    <link rel="stylesheet" href="./styles/overlay.css" />
  </head>
  <body>
    <!-- Overlay screen -->
    <div id="overlay">â–¶ Visit Tuyen's Farm</div>

    <a-scene>
      <!-- Barn -->
      <a-entity barn position="7 1.5 0"></a-entity>

      <!-- Fence row -->
      <a-entity fence="length: 15; count: 20" position="0 0 -10"></a-entity>

      <!-- Cow with walking + mooing animation -->
      <a-entity id="cow" cow="size: 1; color: #fff; spotColor: #000" position="-4 0 3"
        animation__1="property: position; to: 0 0 3; dur: 4000; startEvents: step1; easing: linear"
        animation__2="property: position; to: 4 0 5; dur: 4000; startEvents: step2; easing: linear"
        animation__3="property: position; to: 0 0 5; dur: 4000; startEvents: step3; easing: linear"
        animation__4="property: position; to: -4 0 5; dur: 4000; startEvents: step4; easing: linear"
      ></a-entity>

      <!-- Animals -->
      <a-entity animal="color: #fff" position="2 0 2"></a-entity>
      <a-entity animal="color: #000" position="-2 0 1"></a-entity>

      <!-- Ground -->
      <a-plane rotation="-90 0 0" width="20" height="20" color="#C2B280"></a-plane>
      <a-sky color="#87CEEB"></a-sky>

      <!-- Chicken -->
      <a-entity id="chicken" chicken position="2 0 -3"></a-entity>

      <!-- Farm group -->
      <a-entity position="0 0 -5">
          <!-- Mill -->
          <a-entity mill position="0 0 0"></a-entity>

          <!-- Rice around -->
          <a-entity rice="height:1.2" position="3 0 0"></a-entity>
          <a-entity rice="height:1.2" position="-3 0 0"></a-entity>
          <a-entity rice="height:1.2" position="0 0 3"></a-entity>
          <a-entity rice="height:1.2" position="0 0 -3"></a-entity>
      </a-entity>

      <a-sky color="#87CEEB"></a-sky>

      <script>
        function wait(ms){ return new Promise(r => setTimeout(r, ms)); }
        
        const overlay = document.getElementById("overlay");
        const cow = document.getElementById("cow");
        const chicken = document.getElementById("chicken");

        async function startFarm() {
          // Unlock audio context
          const ctx = AFRAME.scenes[0].audioListener.context;
          if (ctx.state === "suspended") {
            await ctx.resume();
          }

          // Hide overlay
          overlay.style.display = "none";
        }

        overlay.addEventListener("click", startFarm);
        window.addEventListener("keydown", startFarm, { once: true });

        chicken.addEventListener("loaded", async () => {
          while (true) {
              chicken.components.sound.playSound();
              await wait(5000); // cluck every 5s
          }
        });

        cow.addEventListener("loaded", async () => {
          while (true) {
            // Start cow movement + moo loop
            cow.emit("step1");
            cow.components.sound.playSound();
            await wait(4000);

            cow.emit("step2");
            await wait(4000);

            cow.emit("step3");
            cow.components.sound.playSound();
            await wait(4000);

            cow.emit("step4");
            await wait(4000);
          }
        });
      </script>
    </a-scene>
  </body>
</html>
