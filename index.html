<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>A-Frame Farm Scene</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="./components/barn.js"></script>
    <script src="./components/fence.js"></script>
    <script src="./components/animal.js"></script>
    <script src="./components/cow.js"></script>
    <script src="./components/rice.js"></script>
    <script src="./components/mill.js"></script>
  </head>
  <body>
    <a-scene>
        <a-assets>
          <audio id="cow_sound" src="./cows-on-pasture_animal-sound-149489.mp3"></audio>
        </a-assets>
        <!-- Barn -->
        <a-entity barn position="7 1.5 0"></a-entity>

        <!-- Fence row -->
        <a-entity fence="length: 15; count: 20" position="0 0 -10"></a-entity>

        <a-entity id="cow" cow="size: 1; color: #fff; spotColor: #000" position="-4 0 3"
          sound="src: #cow_sound; autoplay: true; loop: true"
          animation__1="property: position; to: 0 0 3; dur: 4000; startEvents: step1; easing: linear"
          animation__2="property: position; to: 4 0 5; dur: 4000; startEvents: step2; easing: linear"
          animation__3="property: position; to: 0 0 5; dur: 4000; startEvents: step3; easing: linear"
          animation__4="property: position; to: -4 0 5; dur: 4000; startEvents: step4; easing: linear"
        ></a-entity>

        <!-- Animals -->
        <a-entity animal="color: #fff" position="2 0 2"></a-entity>
        <a-entity animal="color: #000" position="-2 0 1"></a-entity>

        <!-- Ground -->
        <a-plane rotation="-90 0 0" width="20" height="20" color="#C2B280"></a-plane>
        <a-sky color="#87CEEB"></a-sky>

        <!-- Farm group -->
        <a-entity position="0 0 -5">
            <!-- Mill -->
            <a-entity mill position="0 0 0"></a-entity>

            <!-- Rice around -->
            <a-entity rice="height:1.2" position="3 0 0"></a-entity>
            <a-entity rice="height:1.2" position="-3 0 0"></a-entity>
            <a-entity rice="height:1.2" position="0 0 3"></a-entity>
            <a-entity rice="height:1.2" position="0 0 -3"></a-entity>
        </a-entity>

        <a-sky color="#87CEEB"></a-sky>
        <script>
          // Loop cow movement
          function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
            const cow = document.querySelector("#cow");
            cow.addEventListener("loaded", async () => {
              while (true) {
                cow.emit("step1"); 
                cow.components.sound.playSound();
                await wait(4000);

                cow.emit("step2"); await wait(4000);

                cow.emit("step3");
                cow.components.sound.playSound();
                await wait(4000);
                
                cow.emit("step4"); await wait(4000);
              }
          });
      </script>
    </a-scene>
  </body>
</html>
