<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>A-Frame Farm Scene</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="./components/barn.js"></script>
    <script src="./components/fence.js"></script>
    <script src="./components/animal.js"></script>
    <script src="./components/cow.js"></script>
    <script src="./components/rice.js"></script>
    <script src="./components/mill.js"></script>
    <script src="./components/chicken.js"></script>
    <script src="./components/weather.js"></script>
    <link rel="stylesheet" href="./styles/overlay.css" />
  </head>
  <body>
    <!-- Overlay screen -->
    <div id="overlay">â–¶ Visit Tuyen's Farm</div>

    <!-- Weather Controls -->
    <div id="weather-controls" style="position: fixed; top: 20px; right: 20px; z-index: 1000; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; color: white; font-family: Arial, sans-serif;">
      <h3 style="margin: 0 0 10px 0; font-size: 16px;">Weather Controls</h3>
      <div id="current-weather" style="margin-bottom: 10px; font-size: 14px;">Current: <span id="weather-status">Sunny</span></div>
      <div style="display: flex; gap: 5px; flex-wrap: wrap;">
        <button id="sunny-btn" class="weather-btn" style="padding: 5px 10px; background: #FFD700; color: #000; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">â˜€ï¸ Sunny</button>
        <button id="cloudy-btn" class="weather-btn" style="padding: 5px 10px; background: #B0C4DE; color: #000; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">â˜ï¸ Cloudy</button>
        <button id="rainy-btn" class="weather-btn" style="padding: 5px 10px; background: #708090; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">ğŸŒ§ï¸ Rainy</button>
        <button id="windy-btn" class="weather-btn" style="padding: 5px 10px; background: #A9A9A9; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">ğŸ’¨ Windy</button>
        <button id="storm-btn" class="weather-btn" style="padding: 5px 10px; background: #2F2F2F; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">â›ˆï¸ Storm</button>
      </div>
      <div style="margin-top: 10px;">
        <button id="auto-weather-btn" style="padding: 5px 10px; background: #32CD32; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">ğŸ”„ Auto Weather</button>
      </div>
    </div>

    <a-scene weather="type: sunny; intensity: 1; windSpeed: 1">
      <!-- Weather System -->
      <a-entity weather></a-entity>

      <!-- Barn -->
      <a-entity barn position="7 1.5 0"></a-entity>

      <!-- Fence row -->
      <a-entity fence="length: 15; count: 20" position="0 0 -10"></a-entity>

      <!-- Cow with walking + mooing animation -->
      <a-entity id="cow" cow="size: 1; color: #fff; spotColor: #000" position="-4 0 3"
        animation__1="property: position; to: 0 0 3; dur: 4000; startEvents: step1; easing: linear"
        animation__2="property: position; to: 4 0 5; dur: 4000; startEvents: step2; easing: linear"
        animation__3="property: position; to: 0 0 5; dur: 4000; startEvents: step3; easing: linear"
        animation__4="property: position; to: -4 0 5; dur: 4000; startEvents: step4; easing: linear"
      ></a-entity>

      <!-- Animals -->
      <a-entity animal="color: #fff" position="2 0 2"></a-entity>
      <a-entity animal="color: #000" position="-2 0 1"></a-entity>

      <!-- Ground -->
      <a-plane rotation="-90 0 0" width="20" height="20" color="#C2B280"></a-plane>
      <a-sky color="#87CEEB"></a-sky>

      <!-- Chicken -->
      <a-entity id="chicken" chicken position="2 0 -3"></a-entity>

      <!-- Farm group -->
      <a-entity position="0 0 -5">
          <!-- Mill -->
          <a-entity mill position="0 0 0"></a-entity>

          <!-- Rice around -->
          <a-entity rice="height:1.2" position="3 0 0"></a-entity>
          <a-entity rice="height:1.2" position="-3 0 0"></a-entity>
          <a-entity rice="height:1.2" position="0 0 3"></a-entity>
          <a-entity rice="height:1.2" position="0 0 -3"></a-entity>
      </a-entity>

      <a-sky color="#87CEEB"></a-sky>

      <script>
        function wait(ms){ return new Promise(r => setTimeout(r, ms)); }
        
        const overlay = document.getElementById("overlay");
        const cow = document.getElementById("cow");
        const chicken = document.getElementById("chicken");

        let weatherInterval = null;
        let autoWeatherEnabled = false;

        async function startFarm() {
          // Unlock audio context
          const ctx = AFRAME.scenes[0].audioListener.context;
          if (ctx.state === "suspended") {
            await ctx.resume();
          }

          // Hide overlay
          overlay.style.display = "none";
          
          // Start weather system
          const weatherEntity = document.querySelector('[weather]');
          if (weatherEntity) {
            weatherEntity.components.weather.startWeatherAnimation();
          }
          
          // Setup weather controls
          setupWeatherControls();
        }

        function setupWeatherControls() {
          const weatherEntity = document.querySelector('[weather]');
          const weatherStatus = document.getElementById('weather-status');
          const sunnyBtn = document.getElementById('sunny-btn');
          const cloudyBtn = document.getElementById('cloudy-btn');
          const rainyBtn = document.getElementById('rainy-btn');
          const windyBtn = document.getElementById('windy-btn');
          const stormBtn = document.getElementById('storm-btn');
          const autoWeatherBtn = document.getElementById('auto-weather-btn');

          function changeWeather(weatherType) {
            if (weatherEntity && weatherEntity.components.weather) {
              // Stop auto weather
              if (weatherInterval) {
                clearInterval(weatherInterval);
                weatherInterval = null;
                autoWeatherEnabled = false;
                autoWeatherBtn.textContent = 'ğŸ”„ Auto Weather';
              }

              // Clear existing weather effects
              weatherEntity.components.weather.clearWeatherEffects();
              
              // Update weather type
              weatherEntity.setAttribute('weather', 'type', weatherType);
              
              // Create new weather effects
              weatherEntity.components.weather.createWeatherSystem();
              
              // Update status
              weatherStatus.textContent = weatherType.charAt(0).toUpperCase() + weatherType.slice(1);
              
              console.log(`Weather changed to: ${weatherType}`);
            }
          }

          function toggleAutoWeather() {
            if (autoWeatherEnabled) {
              // Stop auto weather
              if (weatherInterval) {
                clearInterval(weatherInterval);
                weatherInterval = null;
              }
              autoWeatherEnabled = false;
              autoWeatherBtn.textContent = 'ğŸ”„ Auto Weather';
            } else {
              // Start auto weather
              weatherInterval = setInterval(() => {
                const weatherTypes = ['sunny', 'cloudy', 'rainy', 'windy', 'storm'];
                const randomWeather = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
                changeWeather(randomWeather);
              }, 30000);
              autoWeatherEnabled = true;
              autoWeatherBtn.textContent = 'â¹ï¸ Stop Auto';
            }
          }

          // Add event listeners
          sunnyBtn.addEventListener('click', () => changeWeather('sunny'));
          cloudyBtn.addEventListener('click', () => changeWeather('cloudy'));
          rainyBtn.addEventListener('click', () => changeWeather('rainy'));
          windyBtn.addEventListener('click', () => changeWeather('windy'));
          stormBtn.addEventListener('click', () => changeWeather('storm'));
          autoWeatherBtn.addEventListener('click', toggleAutoWeather);
        }

        overlay.addEventListener("click", startFarm);
        window.addEventListener("keydown", startFarm, { once: true });

        chicken.addEventListener("loaded", async () => {
          while (true) {
              chicken.components.sound.playSound();
              await wait(5000); // cluck every 5s
          }
        });

        cow.addEventListener("loaded", async () => {
          while (true) {
            // Start cow movement + moo loop
            cow.emit("step1");
            cow.components.sound.playSound();
            await wait(4000);

            cow.emit("step2");
            await wait(4000);

            cow.emit("step3");
            cow.components.sound.playSound();
            await wait(4000);

            cow.emit("step4");
            await wait(4000);
          }
        });
      </script>
    </a-scene>
  </body>
</html>
